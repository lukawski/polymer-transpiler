<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">


<link rel="import" href="../../../components/hub-cms-visual-composer/hub-cms-visual-composer.html">
<link rel="import" href="../../../components/hub-cms-menu-microsite-edit/hub-cms-menu-microsite-edit.html">
<link rel="import" href="../../../components/hub-cms-microsite-saver/hub-cms-microsite-saver.html">
<link rel="import" href="../../../components/hub-cms-microsite-data-provider/hub-cms-microsite-data-provider.html">
<link rel="import" href="../../../components/hub-cms-lock/hub-cms-lock.html">
<link rel="import" href="../../../components/hub-cms-read-only-bar/hub-cms-read-only-bar.html">
<link rel="import" href="../../../components/hub-cms-localize-behavior/hub-cms-localize-behavior.html">
<link rel="import" href="../../../components/hub-cms-microsite-layout-validator/hub-cms-microsite-layout-validator.html">
<link rel="import" href="../../../components/hub-cms-styles/popup.html">

<!--
Microsites composer view

Example:

    <hub-cms-microsite-edit-view></hub-cms-microsite-edit-view>

@demo demo/index.html
-->

<link rel="import" href="../../src/common/hub-cms-element.html">
<dom-module id="hub-cms-microsite-edit-view">



  <script>
    class HubCmsMicrositeEditView extends Polymer.mixinBehaviors(
      [HubCMSBehaviors.LocalizeBehavior],
      HubCmsElement
    ) {
      static get is() {
        return 'hub-cms-microsite-edit-view';
      }

      static get properties() {
        return {
          micrositeId: {
            type: String
          },
          lastActionDate: {
            type: Date,
            observer: '_lastActivityChanged'
          },
          lockInterval: {
            type: Number
          },
          _microsite: {
            type: Object
          },
          _urlInfo: {
            type: Object
          },
          _layout: {
            type: Object
          },
          _statuses: {
            type: Object
          },
          _pageConfig: {
            type: Object
          },
          _dataLoaded: {
            type: Boolean,
            value: true
          },
          _micrositeInvalid: {
            type: Boolean,
            value: false
          },
          _currentBlade: {
            type: String,
            value: 'build',
            reflectToAttribute: true
          },
          _readOnly: {
            type: Boolean,
            value: false
          },
          _skipAdvertValidation: {
            type: Boolean,
            value: false
          },
          _saveEnabled: {
            type: Boolean,
            value: false
          },
          _blockActions: {
            type: Boolean,
            value: false,
            computed: '_computeBlockActions(_readOnly, _saving)'
          },
          _saving: {
            type: Boolean,
            value: false
          },
          _currentDeleting: {
            type: Object,
            value: null
          }
        };
      }

      static get observers() {
        return [
          '_routeDataChanged(routeData.id)',
          '_micrositeDataChanged(_microsite.*, _urlInfo.*)'
        ];
      }

      static get template() {
        return Polymer.html `
<style include="hub-cms-styles-popup">
</style>

<style>
  :host {
    @apply --layout-wrapper;
    --app-drawer-width: 3.75rem !important;
    /* leave this important here :) */
  }

  app-drawer {
    @apply --hub-elevation-5;
    z-index: 10;
    transition: width 0.2s;
    --app-drawer-content-container: {
      width: 100%;
      background: var(--cms-color-900);
    }
    ;
  }

  hub-cms-popup-share-link ::slotted( paper-dialog) {
    position: fixed;
    bottom: 3.75rem;
    left: 4.25rem;
    margin: 0;
  }
</style>

<app-route route="{{route}}" pattern="/edit/microsite/:id" data="{{routeData}}"></app-route>

<hub-cms-microsite-layout-validator id="validator"></hub-cms-microsite-layout-validator>

<hub-cms-microsite-data-provider microsite-id="[[micrositeId]]" on-data-loading="_onDataLoading" on-data-ready="_dataReady"></hub-cms-microsite-data-provider>

<hub-cms-lock id="cmsLock" item-id="[[micrositeId]]" type="microsite"></hub-cms-lock>

<iron-meta id="language" key="language" value$="[[_sharedElementsLanguage]]"></iron-meta>

<hub-cms-popup-share-link id="shareLinkDialog" type="Microsites" item-id="[[_microsite.id]]" item-version="[[_microsite.aggregateVersion]]" toggle-share="[[_microsite.shared]]"></hub-cms-popup-share-link>

<app-drawer-layout>

  <app-drawer slot="drawer" position="left" persistent="" opened="">

    <hub-cms-menu-microsite-edit id="menu" microsite="[[_microsite]]" statuses="[[_statuses]]" layout="[[_layout]]" current-blade="{{_currentBlade}}" on-save-microsite="_onSaveMicrosite" read-only="[[_blockActions]]"></hub-cms-menu-microsite-edit>

  </app-drawer>

  <div class="content">

    <template is="dom-if" if="[[_readOnly]]" restamp="">
      <hub-cms-read-only-bar editing-author="[[_editingAuthor]]"></hub-cms-read-only-bar>
    </template>

    <hub-cms-microsite-saver id="siteSaver" microsite="{{_microsite}}" url-info="{{_urlInfo}}" layout="{{_layout}}" page-config="[[_pageConfig]]" saving="{{_saving}}" on-microsite-saved="_micrositeSaved" on-microsite-not-saved="_micrositeNotSaved"></hub-cms-microsite-saver>

    <hub-cms-visual-composer id="visualComposer" microsite="{{_microsite}}" url-info="{{_urlInfo}}" layout="{{_layout}}" statuses="[[_statuses]]" page-config="[[_pageConfig]]" current-blade="{{_currentBlade}}" on-save-microsite="_onSaveMicrosite" on-show-editor-icon="_showEditorIcon"
      on-hide-editor-icon="_hideEditorIcon" read-only="[[_blockActions]]">
      <slot name="yoast" slot="yoast"></slot>
      <slot name="microsite-content" slot="microsite-content"></slot>
    </hub-cms-visual-composer>

  </div>

</app-drawer-layout>

<hub-cms-popup id="emptyAdverts">
  <h2>[[localize('unconfiguredAdverts')]]</h2>
  <p>[[localize('publishWithoutAdsWarning')]]</p>
  <div class="paper-dialog-buttons">
    <paper-button dialog-dismiss="">[[localize('dismiss')]]</paper-button>
    <paper-button dialog-confirm="" on-tap="_skipAdvertValidationAndSave">[[localize('ok')]]</paper-button>
  </div>
</hub-cms-popup>

<hub-cms-popup id="unsavedDialog">
  <h2>[[localize('unsavedChanges')]]</h2>
  <p>[[localize('saveChangesQuestion')]]</p>
  <div class="paper-dialog-buttons">
    <paper-button dialog-dismiss="" on-tap="_goBack">[[localize('cancel')]]</paper-button>
    <paper-button dialog-confirm="" on-tap="_saveAndQuit">[[localize('save')]]</paper-button>
  </div>
</hub-cms-popup>

<hub-cms-popup id="confirmDeletionDialog">
  <h2>[[localize('doYouWantToDeleteThisElementPermanently')]]</h2>
  <div class="paper-dialog-buttons">
    <paper-button dialog-dismiss="">[[localize('cancel')]]</paper-button>
    <paper-button dialog-confirm="" on-tap="_confirmDeletionElement">[[localize('delete')]]</paper-button>
  </div>
</hub-cms-popup>

<hub-cms-dialog-anchor id="openAnchorDialog" dialog-type="Anchor" dialog-target="Microsite"></hub-cms-dialog-anchor> `;
      }

      ready() {
        super.ready();
        this.addEventListener('open-blade', this._openBlade);
        this.addEventListener('close-blades', this._closeBlades);
        this.addEventListener('element-changed', this._elementChanged);
        this.addEventListener(
          'toggle-share-link-popup',
          this._toggleShareLinkPopup
        );
        this.addEventListener(
          'microsite-confirm-removing-draggable-item',
          this._onMicrositeConfirmRemoveDraggableItem
        );
        this.addEventListener(
          'microsite-remove-draggable-item',
          this._onMicrositeRemoveDraggableItem
        );
        this.addEventListener('disable-save-button', this._onDisableSaveButton);
        this.addEventListener(
          'editing-user-changed',
          this._onEditingUserChanged
        );
        this.addEventListener('set-read-only', this._onSetReadOnly);
        this.addEventListener('leave-microsite', this._onLeaveMicrosite);
        this.addEventListener('editor-size-changed', this._setEditorSize);
        this.addEventListener(
          'microsite-or-article-url-changed',
          this._onUrlChange
        );
        this.addEventListener(
          'microsite-or-article-seo-score-changed',
          this._onSeoScoreChange
        );
        this.addEventListener(
          'microsite-or-article-seo-changed',
          this._onSeoPageConfigChange
        );
      }

      connectedCallback() {
        super.connectedCallback();
        var dialogType;
        this.$.visualComposer.addEventListener('click', e => {
          dialogType = e.target.classList.contains('article-link') ?
            'AnchorDialog' :
            false;
          if (dialogType) {
            this.$['open' + dialogType].open(
              e.target,
              this._readButtonProps(e.target)
            );
            e.preventDefault();
          }
        });
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        var content = document.querySelector('#microsite-content');
        if (content) content.innerHTML = null;

        clearInterval(this.lockInterval);
      }

      _computeBlockActions(_readOnly, _saving) {
        return _readOnly || _saving;
      }

      _readButtonProps(node) {
        return {
          text: node.textContent,
          href: node.getAttribute('href'),
          target: node.getAttribute('target'),
          rel: node.getAttribute('rel')
        };
      }

      _saveAndQuit() {
        this._saveMicrosite('save');
        this._goBack();
      }

      _skipAdvertValidationAndSave() {
        this.set('_skipAdvertValidation', true);
        this._saveMicrosite('save');
      }

      _goBack() {
        this.fire('page-change', 'microsites/list');
      }

      _onLeaveMicrosite() {
        if (this._saveEnabled) {
          this.$.unsavedDialog.open();
        } else {
          this._goBack();
        }
      }

      _onDisableSaveButton(e) {
        if (!this._statuses) return;
        this.$.menu.setSaveDisabled(e.detail);
        this.set('_micrositeInvalid', e.detail);
      }

      _onDataLoading(e) {
        this._dataLoaded = e.detail.dataLoaded;
      }

      _routeDataChanged(id) {
        if (id === undefined) return;
        this.set('micrositeId', id);
      }

      _checkLocks() {
        var currentStatus = this._statuses.find(
          function(status) {
            return status.id == this._microsite.statusId;
          }.bind(this)
        );

        if (currentStatus.identifier === 'archived') {
          this.fire('set-read-only', {
            readOnly: true
          });
        }
      }

      _dataReady(e) {
        this._microsite = e.detail.microsite;
        this._urlInfo = e.detail.urlInfo;
        this._layout = e.detail.layout;
        this._statuses = e.detail.statuses;
        this._pageConfig = e.detail.pageConfig;
        this._sharedElementsLanguage = this._microsite.cultureCode || 'en-GB';
        this._checkLocks();
        this.debounce(
          'microsite-edit-data-loaded',
          function() {
            this._dataLoaded = true;
          },
          50
        );
        var currentStatus = this._statuses.find(
          function(status) {
            return status.id == this._microsite.statusId;
          }.bind(this)
        );
        currentStatus.identifier !== 'archived' ?
          this.$.cmsLock.checkLock() :
          this.fire('set-read-only', {
            readOnly: true
          });
        if (currentStatus.identifier !== 'archived' && !this.lockInterval) {
          this.setLockInterval();
        }
      }

      setLockInterval() {
        var min = 1;
        this._checkMicrositeActivity();
        this.lockInterval = setInterval(
          this._checkMicrositeActivity.bind(this),
          min * 60000
        );
      }

      _checkMicrositeActivity() {
        var timeFromLastAction = parseFloat(
          ((new Date() - this.lastActionDate) / 60000).toFixed(2)
        );
        var active = timeFromLastAction < 2;
        if (active) {
          this.$.cmsLock.checkLock();
        } else if (this.$.menu.saveDisabled && !active) {
          clearInterval(this.lockInterval);
          this.lockInterval = false;
        }
      }

      _lastActivityChanged(newDate, oldDate) {
        if (this.$.menu.saveDisabled && !this.lockInterval) {
          this.setLockInterval();
        }
      }

      _elementChanged(e) {
        this.$.visualComposer.setNode();

        this.debounce(
          'microsite-element-changed',
          function() {
            this._enableSave();
          },
          250
        );
      }

      _seoChanged(e) {
        this.debounce(
          'microsite-element-changed',
          function() {
            this._enableSave();
          },
          250
        );

        this.$.visualComposer.setNode();
      }

      _micrositeSaved(e) {
        if (e.detail.saveType === 'save') {
          this.lastActionDate = new Date();
        }
        var keyword =
          e.detail.saveType === 'save' ?
          'changesSaved' :
          'changesAutoSavedDisketteInfo';
        var duration = keyword === 'changesSaved' ? 6000 : 0;
        this.fire('toast', {
          type: 'info',
          text: keyword,
          duration: duration
        });
      }

      _micrositeNotSaved(e) {
        this.fire('toast', {
          type: 'error',
          errorData: {
            errorCode: 'sthWentWrong'
          }
        });
      }

      _micrositeDataChanged(microsite, urlInfo) {
        if (
          microsite === undefined ||
          urlInfo === undefined ||
          urlInfo.value === undefined
        ) {
          return;
        }
        /*
         * ensure that property has been changed and not whole object, so if no dots in path then no property changed
         */
        if (
          microsite.path.indexOf('.') === -1 &&
          urlInfo.path.indexOf('.') === -1
        ) {
          return;
        }
        this._enableSave();
      }

      _enableSave() {
        if (!this._dataLoaded) {
          return;
        }
        if (this.$.menu.saveDisabled && !this._micrositeSlugInvalid) {
          this.lastActionDate = new Date();
          this.$.menu.setSaveDisabled(false);
          this._saveEnabled = true;
        }
      }

      _setEditorSize(e) {
        this._editorSize = e.detail;
      }

      _onSaveMicrosite(e) {
        var saveType = !!(e.detail && e.detail.length) ? e.detail : 'save';
        this._saveMicrosite(saveType);
      }

      _saveMicrosite(saveType) {
        var layoutNode = this.$.visualComposer.getLayoutNode();
        var dataValid = this._validateData(layoutNode);
        var advertsValid = this._validateAdvertsData(layoutNode);
        if (!dataValid || !advertsValid) return;
        this.fire('toast', {
          type: 'info',
          text: 'savingData'
        });
        this._closeBlades();
        this.$.menu.setSaveDisabled(true);
        this._saveEnabled = false;
        this.$.siteSaver.save(layoutNode, saveType);
      }

      _onEditingUserChanged(e) {
        this.set('_editingAuthor', e.detail.editingAuthor);
      }

      _onSetReadOnly(e) {
        this.set('_readOnly', e.detail.readOnly);
        if (this._readOnly) {
          this.$.menu.setSaveDisabled(true);
          this._saveEnabled = false;
          this._closeBlades();
          clearInterval(this.lockInterval);
        }
      }

      _validateStickyAdvertAttributes(item, position) {
        return (
          item.hasAttribute(position + '-ad-show') &&
          (!item.hasAttribute(position + '-ad-element') ||
            !item.hasAttribute(position + '-ad-size') ||
            !item.hasAttribute(position + '-ad-path'))
        );
      }

      _validateAdvertsData(layoutNode) {
        var currentStatus = this._statuses.find(
          function(status) {
            return status.id == this._microsite.statusId;
          }.bind(this)
        );
        if (currentStatus.identifier === 'published') {
          if (this._skipAdvertValidation) {
            this.set('_skipAdvertValidation', false);
            return true;
          }
          var emptyInContentAdvert = [
            ...layoutNode.querySelectorAll(
              'hub-cms-draggable-item[editor="advert"]'
            )
          ].find(
            item =>
            !item.element.element ||
            !item.element.path ||
            !item.element.size
          );
          var emptyStickyAdvert = [
            ...layoutNode.querySelectorAll(
              'hub-cms-draggable-item[editor="row"]'
            )
          ].find(item => {
            var rigthStickyInvalid = this._validateStickyAdvertAttributes(
              item.element,
              'right'
            );
            var leftStickyInvalid = this._validateStickyAdvertAttributes(
              item.element,
              'left'
            );
            if (rigthStickyInvalid || leftStickyInvalid) {
              return item;
            }
          });

          if (emptyStickyAdvert || emptyInContentAdvert) {
            var advert = emptyStickyAdvert || emptyInContentAdvert;
            advert.highlight();
            advert.editor && advert.$$('#edit').click();
            this.async(() => {
              this.$.emptyAdverts.open();
            }, 500); // I can explain, this is added due to highlight behavior.
            return false;
          } else {
            return true;
          }
        } else {
          return true;
        }
      }

      _validateData(layoutNode) {
        var valid = this._microsite.title && this._urlInfo.urlRelative;

        if (!valid) {
          this.set('_currentBlade', 'details');
        }

        var layoutValidationResults = this.$.validator.validate(layoutNode);

        if (layoutValidationResults.errors.length !== 0) {
          this.fire('toast', {
            type: 'error',
            errorData: {
              errorsList: layoutValidationResults.errors,
              errorCode: 'sthWentWrong'
            }
          });

          return false;
        } else {
          this.$.visualComposer.$.blades.$.detailsEdit.$.urlRelative.validate();
          this.$.visualComposer.$.blades.$.detailsEdit.$.micrositeTitle.validate();

          return valid;
        }
      }

      _toggleShareLinkPopup(e) {
        this.$.shareLinkDialog.toggle();
      }

      _onMicrositeRemoveDraggableItem(e) {
        if (this._currentBlade === e.detail.editor) {
          this._closeBlades();
        }
      }

      _onMicrositeConfirmRemoveDraggableItem(e) {
        this._currentDeleting = e.detail;
        this.$.confirmDeletionDialog.open();
      }

      _confirmDeletionElement() {
        if (this.$.visualComposer.$.preview) {
          this.$.visualComposer.$.preview.dispatchEvent(
            new CustomEvent('microsite-remove-draggable-item', {
              detail: this._currentDeleting,
              bubbles: true,
              composed: true
            })
          );
        }
        this._currentDeleting = null;
      }

      _openBlade(e) {
        this.set('_currentBlade', e.detail);
      }

      _closeBlades() {
        this.set('_currentBlade', null);
      }

      _showEditorIcon() {
        this.$.menu.showEditorIcon();
      }

      _hideEditorIcon() {
        this.$.menu.hideEditorIcon();
      }

      _onUrlChange(e) {
        this._enableSave();
        this._urlInfo.urlRelative = e.detail;
      }

      _onSeoScoreChange(e) {
        this._enableSave();
        this._microsite.seoScore = e.detail;
      }

      _onSeoPageConfigChange(e) {
        this._enableSave();
        this._pageConfig.head = e.detail;
      }
    }

    customElements.define(HubCmsMicrositeEditView.is, HubCmsMicrositeEditView);
  </script>

</dom-module>